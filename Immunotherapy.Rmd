---
title: "Immunotherapy"
author: "Andreea Murariu"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
#Installation of Packages edgeR, DESeq2, and ALDEx2
library(edgeR,quietly=T) 
library(DESeq2,quietly=T)
library(ALDEx2,quietly=T)
```

```{r}
#Setting the Working Directory
#andreea setting
## gg may comment this out 
setwd("/Users/andreeamurariu/Documents/github/3383-Project/")
getwd() 
```

```{r}
readCount<-read.table(file="data/GSE91061_raw_counts_GRCh38.p13_NCBI.tsv", header = T, skip=35, sep='\t', row.names = 1)
#pull out just the accession numbers and patient identifiers and put them in another file
d <- read.table(file="data/metadata.txt", header=F, row.names=1, sep='\t')
```

```{r}
#setting conditions for the dataset
conditions <- rep("Pre", 109)
grep("_On",d)
conditions[grep("_On",d)] <- "On"
conds <- data.frame(conditions)
conds$condition <- factor(conds$condition)
```


1) Using DESeq2 to identify differentially expressed genes (DEGs) in the Immunotherapy Dataset 

```{r}
# use edgeR filtering for rows as SOP
keep<-filterByExpr(readCount) 
read.keep <- readCount[keep,]

#Creating a DESeqDataSet
dds <- DESeqDataSetFromMatrix(countData = read.keep,colData = conds, design= ~condition) 

#DESeq2 analysis
deseq2out <- DESeq (dds) # use the default test
res <- results(deseq2out)
plotMA(res) # show the MA plot
res

#generating effect-size plots in DESeq2
lfcShrink(res)
plotDispEsts(dds)
```

```{r}
#Random Permutation and Sampling
#1. Setting conditions
conds2 <- c(rep("Pre",5),rep("_On",5))
presampl <- which(conds2=="Pre")
onsampl <- which(conds2=="_On")

#Pulling a random sample, assigning it to a seed
set.seed(125)
random.pre <- sample(presampl,size = 5)
random.on <- sample(onsampl,size = 5)
groups.10 <- conds2[c(random.pre,random.on)]
df2.10 <- read.keep[,c(random.pre,random.on)]
groups.10.rand2 <- sample(groups.10)

#rerun DESeq2 with permuted data set - need to edit so that it works with DESeq2
dds2 <- DESeqDataSetFromMatrix(countData = df2.10,colData = groups.10.rand2, design= ~condition) ##edit this, attempt to set rownames 
deseq2outperm <- DESeq (dds) # use the default test
resperm <- results(deseq2outperm)
plotMA(resperm) # show the MA plot
resperm

#generating effect-size plots in DESeq2 - need to check how to make effect size plots here
lfcShrink(dds)

```

2) Using ALDEx2 to identify differentially expressed genes (DEGs) in the Immunotherapy Dataset 
ALDEx2 t-test and Wilcoxon rank-sum test
```{r}
#ALDEx2 code for differing gamma values (1e-3, 0.2, 0.5, 1)
read.keep <- readCount[keep,]
aldex.out <- aldex(read.keep, conditions, gamma=1e-3)
aldex.0.2 <- aldex(read.keep, conditions, gamma=0.2)
aldex.0.5 <- aldex(read.keep, conditions, gamma=0.5) 
aldex.1 <- aldex(read.keep, conditions, gamma=1) 

save(aldex.out, file="output/aldex.out.imm.Rda")
save(aldex.0.2, file="output/aldex.0.2.imm.Rda")
save(aldex.0.5, file="output/aldex.0.5.imm.Rda")
save(aldex.1, file="output/aldex.1.imm.Rda")

load(file="output/aldex.out.imm.Rda")
load(file="output/aldex.0.2.imm.Rda")
load(file="output/aldex.0.5.imm.Rda")
load(file="output/aldex.1.imm.Rda")

pdf("no-gamma.imm.pdf", height=5, width=7)
aldex.plot(aldex.out)

pdf("gamma0.2.imm.pdf", height=5, width=7)
aldex.plot(aldex.0.5)

pdf("gamma.0.5.imm.pdf", height=5, width=7)
aldex.plot(aldex.1)

pdf("gamma.1.imm.pdf", height=5, width=7)
aldex.plot(aldex.5)


#Generating graphs for Wilcoxon and t-tests - need to verify how to get 2 different effect size plots for each
aldex1e3wilc <- aldex.out <- aldex(read.keep, conditions,test="t",gamma=1e-3)
aldex.plot(aldex1e3wilc)

```


```{r}
#Random Permutation and Sampling
#1. Setting conditions
conds2 <- c(rep("Pre",5),rep("_On",5))
presampl <- which(conds2=="Pre")
onsampl <- which(conds2=="_On")

#Pulling a random sample, assigning it to a seed
set.seed(123)
random.pre <- sample(presampl,size = 5)
random.on <- sample(onsampl,size = 5)
groups.10 <- conds2[c(random.pre,random.on)]
df.10 <- read.keep[,c(random.pre,random.on)]
groups.10.rand <- sample(groups.10)

#ALDEX Running of data and effect size plot generation
aldexp1e-3<-aldex(df.10,groups.10,gamma=1e-3)
aldex.plot(aldexoutp1e-3)
aldex.p.0.2 <- aldex(read.keep, r.conds, gamma=0.2)
aldex.plot(aldex.p.0.2)
aldex.p.0.5 <- aldex(read.keep, r.conds, gamma=0.5) 
aldex.plot(aldex.p.0.5)
aldex.p.1 <- aldex(read.keep, r.conds, gamma=1) 
aldex.plot(aldex.p.1)


#trying to generate a for loop for random permutations
for (x in 1:100) 
  {set.seed(x)
  random.pre <- sample(presampl,size = 5)
  random.on <- sample(onsampl,size = 5)
  groups.10 <- conds2[c(random.pre,random.on)]
  df.10 <- read.keep[,c(random.pre,random.on)]
  groups.10.rand <- sample(groups.10)
  loopedaldexperm <- aldex(df.10,groups.10,gamma=0.2)
  aldex.plot(loopedaldexperm)}
```

